# Payment Data Documentation

## 📊 **WHAT PAYMENT DATA IS SAVED WHEN PAYMENT IS COMPLETED**

When a payment is successfully completed, the following data is saved in the **Payment** model:

### **🔑 Razorpay Specific Data:**
```javascript
{
  // Razorpay Order ID (from Razorpay)
  razorpayOrderId: "order_ABC123456789",
  
  // Razorpay Payment ID (from Razorpay)
  paymentId: "pay_XYZ987654321",
  
  // Internal transaction ID (generated by us)
  transactionId: "TXN1753775108960",
  
  // Payment signature for verification
  razorpaySignature: "abc123def456...",
  
  // Signature verification status
  signatureValid: true
}
```

### **💰 Payment Details:**
```javascript
{
  // Payment amount in paise (₹1000 = 100000)
  amount: 115000,
  
  // Currency (default: INR)
  currency: "INR",
  
  // Payment status
  paymentStatus: "paid", // pending, authorized, captured, paid, failed, refunded
  
  // Payment method used
  paymentMethod: "card", // card, netbanking, upi, wallet, etc.
  
  // Payment date (Indian time)
  paymentDate: "15/01/2024, 16:00:00",
  
  // When payment was captured (Indian time)
  capturedAt: "15/01/2024, 16:00:00"
}
```

### **📦 Order Details:**
```javascript
{
  // Internal order ID
  orderId: "ORD1753775108960HB7BH",
  
  // Order total amount
  orderTotal: 1150,
  
  // Order items
  orderItems: [
    {
      productId: "PROD001",
      title: "iPhone 15 Pro",
      description: "Latest iPhone model",
      quantity: 1,
      price: 1000,
      img: "iphone15pro.jpg"
    }
  ]
}
```

### **🏠 Address Information:**
```javascript
{
  // Shipping address
  shippingAddress: {
    houseName: "123 Main Street",
    streetArea: "Downtown Area",
    city: "Mumbai",
    state: "Maharashtra",
    country: "India",
    pincode: "400001"
  },
  
  // Billing address
  billingAddress: {
    houseName: "123 Main Street",
    streetArea: "Downtown Area",
    city: "Mumbai",
    state: "Maharashtra",
    country: "India",
    pincode: "400001"
  }
}
```

### **👤 User Information:**
```javascript
{
  // User ID reference
  userId: "507f1f77bcf86cd799439011",
  
  // User details (from User model)
  user: {
    _id: "507f1f77bcf86cd799439011",
    firstName: "John",
    lastName: "Doe",
    email: "john.doe@example.com",
    phone: "9876543210"
  }
}
```

### **🎫 Discounts & Rewards:**
```javascript
{
  // Coupon code used
  couponCode: "SAVE10",
  
  // Reward points used
  rewardPointsUsed: 100
}
```

### **🔒 Security & Verification:**
```javascript
{
  // Webhook processing status
  webhookStatus: "verified", // received, verified, failed
  
  // Error details (if payment failed)
  errorCode: null,
  errorDescription: null
}
```

### **⏰ Timestamps (Indian Time):**
```javascript
{
  // When payment was created (Indian time)
  createdAt: "15/01/2024, 15:55:00",
  
  // When payment was last updated (Indian time)
  updatedAt: "15/01/2024, 16:00:00",
  
  // When payment was captured (Indian time)
  capturedAt: "15/01/2024, 16:00:00",
  
  // When payment was refunded (if applicable)
  refundedAt: null
}
```

## 🔄 **PAYMENT FLOW & DATA SAVING**

### **1. Order Creation (Payment Pending):**
```javascript
// When order is created, payment record is saved with:
{
  transactionId: "TXN1753775108960",
  razorpayOrderId: "order_ABC123456789",
  paymentId: null, // Not assigned yet
  paymentStatus: "pending",
  amount: 115000,
  orderId: "ORD1753775108960HB7BH",
  userId: "507f1f77bcf86cd799439011",
  // ... other order details
}
```

### **2. Payment Capture (Payment Completed):**
```javascript
// When payment is captured, additional data is saved:
{
  paymentId: "pay_XYZ987654321", // From Razorpay
  paymentStatus: "captured",
  paymentMethod: "card",
  capturedAt: "2024-01-15T10:30:00.000Z",
  razorpaySignature: "abc123def456...",
  signatureValid: true,
  webhookStatus: "verified"
}
```

### **3. Webhook Processing (Real-time Updates):**
```javascript
// When Razorpay webhook is received:
{
  paymentStatus: "captured", // Updated from webhook
  paymentMethod: "card", // Updated from webhook
  webhookStatus: "verified",
  signatureValid: true,
  capturedAt: "2024-01-15T10:30:00.000Z"
}
```

## 📋 **COMPLETE PAYMENT RECORD EXAMPLE**

```javascript
{
  _id: "507f1f77bcf86cd799439012",
  
  // Razorpay Data
  transactionId: "TXN1753775108960",
  paymentId: "pay_XYZ987654321",
  razorpayOrderId: "order_ABC123456789",
  
  // Payment Details
  amount: 115000,
  currency: "INR",
  paymentStatus: "paid",
  paymentMethod: "card",
  paymentDate: "15/01/2024, 16:00:00",
  capturedAt: "15/01/2024, 16:00:00",
  
  // Order Details
  orderId: "ORD1753775108960HB7BH",
  orderTotal: 1150,
  orderItems: [
    {
      productId: "PROD001",
      title: "iPhone 15 Pro",
      description: "Latest iPhone model",
      quantity: 1,
      price: 1000,
      img: "iphone15pro.jpg"
    }
  ],
  
  // Address Details
  shippingAddress: {
    houseName: "123 Main Street",
    streetArea: "Downtown Area",
    city: "Mumbai",
    state: "Maharashtra",
    country: "India",
    pincode: "400001"
  },
  billingAddress: {
    houseName: "123 Main Street",
    streetArea: "Downtown Area",
    city: "Mumbai",
    state: "Maharashtra",
    country: "India",
    pincode: "400001"
  },
  
  // User Reference
  userId: "507f1f77bcf86cd799439011",
  
  // Security & Verification
  webhookStatus: "verified",
  signatureValid: true,
  razorpaySignature: "abc123def456...",
  
  // Discounts & Rewards
  couponCode: "SAVE10",
  rewardPointsUsed: 100,
  
  // Error Handling (null for successful payments)
  errorCode: null,
  errorDescription: null,
  
  // Timestamps
  createdAt: "2024-01-15T10:25:00.000Z",
  updatedAt: "2024-01-15T10:30:00.000Z",
  refundedAt: null
}
```

## 🔍 **API ENDPOINTS FOR PAYMENT DATA**

### **1. Get Payment Details:**
```
GET /api/payment/payment/:paymentId
Authorization: Bearer <token>
```

### **2. Get User's Payment History:**
```
GET /api/payment/user-payments
Authorization: Bearer <token>
```

### **3. Get Order Payment Details:**
```
GET /api/payment/order/:orderId
Authorization: Bearer <token>
```

## 📊 **PAYMENT STATUS FLOW**

1. **pending** → Order created, payment initiated
2. **authorized** → Payment authorized by bank
3. **captured** → Payment captured by Razorpay
4. **paid** → Payment completed successfully (final status)
5. **failed** → Payment failed
6. **refunded** → Payment refunded

## ✅ **VERIFICATION FEATURES**

- **Signature Verification**: All payments are verified using Razorpay signature
- **Webhook Processing**: Real-time updates from Razorpay
- **Duplicate Prevention**: Unique constraints on payment IDs
- **Error Tracking**: Failed payments are logged with error details
- **Audit Trail**: Complete timestamps for all payment events

## 🎯 **SUMMARY**

When a payment is completed, the system saves:

✅ **Complete Razorpay data** (Order ID, Payment ID, Signature)  
✅ **Payment details** (Amount, Method, Status, Timestamps)  
✅ **Order information** (Items, Total, Addresses)  
✅ **User reference** (User ID and details)  
✅ **Security data** (Signature verification, Webhook status)  
✅ **Discount information** (Coupons, Reward points)  
✅ **Error handling** (For failed payments)  
✅ **Complete audit trail** (All timestamps)  

This ensures complete payment tracking and verification! 💳 